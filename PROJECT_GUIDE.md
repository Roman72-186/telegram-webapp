# Полное руководство по проекту Telegram Web App

## Содержание
1. [Общая информация](#общая-информация)
2. [Структура проекта](#структура-проекта)
3. [Описание файлов](#описание-файлов)
4. [Как клонировать проект для других аккаунтов Leadteh](#как-клонировать-проект-для-других-аккаунтов-leadteh)
5. [Настройка интеграции с Leadteh](#настройка-интеграции-с-leadteh)
6. [Тестирование интеграции](#тестирование-интеграции)
7. [Деплой проекта](#деплой-проекта)

## Общая информация

Telegram Web App - это веб-приложение, которое интегрировано с системой Leadteh для обработки регистраций пользователей. Проект позволяет пользователям регистрироваться через Telegram Web App, заполняя форму с именем, фамилией и номером телефона. После отправки данные направляются в систему Leadteh через специальный вебхук.

## Структура проекта

```
telegram-webapp/
├── index.html                 # Главная страница с формой регистрации
├── api/
│   ├── submit.js             # Серверная функция (валидация, верификация initData, отправка в Leadteh)
│   └── contact.js            # Серверная функция (предзаполнение формы по telegram_id)
├── setup.js                  # Мастер установки (8 шагов: webhook, документы, токены, деплой)
├── install.bat               # Bootstrap-скрипт для Windows
├── install.sh                # Bootstrap-скрипт для macOS/Linux
├── vercel.json               # Конфигурационный файл для Vercel
├── README.md                 # Основное описание проекта
├── CLAUDE.md                 # Инструкции для AI-ассистента
├── LEADTEX_INTEGRATION.md    # Инструкция по интеграции с Leadteh
├── TESTING_INSTRUCTIONS.md   # Инструкция по тестированию интеграции
├── PROJECT_GUIDE.md          # Настоящий документ
└── ИНСТРУКЦИЯ.txt            # Краткая инструкция для покупателей
```

## Описание файлов

### index.html
Основная страница приложения с формой регистрации. Содержит:
- Форму с полями: имя, фамилия, телефон
- Чекбоксы для согласия с документами
- Валидацию полей формы
- Интеграцию с Telegram Web App API
- Отправку данных на серверный эндпоинт

### api/submit.js
Серверная функция (Vercel Serverless Function) для обработки отправки формы:
- Принимает POST-запросы с данными пользователя
- Проверяет формат данных (имя, фамилия, телефон, telegram_id)
- Верификация initData через HMAC-SHA256 (если задана env-переменная `TELEGRAM_BOT_TOKEN`)
- Валидация telegram_id — должен быть положительным целым числом
- Отправляет данные во внешний вебхук Leadteh
- Возвращает результат в формате JSON

### api/contact.js
Серверная функция для предзаполнения формы:
- Принимает GET-запрос с параметром `telegram_id`
- Ищет контакт в Leadteh через REST API (`GET /api/v1/getContacts`)
- Возвращает имя, фамилию и телефон для предзаполнения формы
- Требует env-переменную `LEADTEH_API_TOKEN`

### vercel.json
Конфигурационный файл для Vercel:
- Определяет настройки деплоя
- Может содержать маршруты и другие настройки

### README.md
Основное описание проекта, его функций и инструкции по использованию.

### LEADTEX_INTEGRATION.md
Подробная инструкция по интеграции с системой Leadteh.

### TESTING_INSTRUCTIONS.md
Инструкция по тестированию интеграции с Leadteh.

### PROJECT_GUIDE.md
Настоящий документ с полным руководством по проекту.

## Как клонировать проект для других аккаунтов Leadteh

### Шаг 1: Клонирование репозитория

```bash
git clone https://github.com/[ваш-аккаунт]/telegram-webapp.git
cd telegram-webapp
```

### Шаг 2: Установка зависимостей (если есть)

Проект не имеет серверных зависимостей, но если вы добавите какие-либо, установите их:

```bash
npm install
```

### Шаг 3: Настройка через мастер установки

Проще всего настроить проект через мастер установки:

```bash
node setup.js
```

Мастер пройдёт через 8 шагов:
1. Проверка окружения (Node.js, Git)
2. Настройка Webhook URL из Leadteh
3. Обновление конфигурации
4. Ссылки на документы (оферта, политика, обработка данных)
5. API-токен Leadteh (для предзаполнения формы)
6. Токен Telegram-бота (для HMAC-SHA256 верификации initData)
7. Проверка Vercel CLI
8. Деплой на Vercel

Либо вручную — измените вебхук в файле `api/submit.js`:

1. Откройте файл `api/submit.js`
2. Найдите строку с вебхуком Leadteh:
   ```javascript
   const WEBHOOK_URL = 'https://[ваш-аккаунт].leadteh.ru/inner_webhook/[ваш-uuid]';
   ```
3. Замените на ваш вебхук Leadteh

### Шаг 4: Настройка Leadteh

1. Войдите в ваш аккаунт Leadteh
2. Перейдите в раздел "Настройки" → "Webhooks"
3. Создайте новый Inner Webhook
4. Скопируйте URL вебхука
5. Настройте сценарий обработки заказа, как описано в LEADTEX_INTEGRATION.md

### Шаг 5: Обновление переменных в коде

Если вы хотите изменить формат данных, отправляемых в Leadteh, отредактируйте объект `payloadToLeadteh` в файле `api/submit.js`:

```javascript
const payloadToLeadteh = {
  contact_by: 'telegram_id',
  search: String(telegram_id),
  variables: {
    // Добавьте или измените переменные по необходимости
    customer_name: `${firstName} ${lastName}`,
    customer_phone: phone,
    // ... другие переменные
  }
};
```

### Шаг 6: Тестирование

Протестируйте интеграцию, следуя инструкциям в TESTING_INSTRUCTIONS.md

## Настройка интеграции с Leadteh

### Шаг 1: Создание бота в Telegram

1. Создайте нового бота через @BotFather
2. Получите токен бота
3. Настройте бота для использования с Web App

### Шаг 2: Настройка Leadteh

1. Создайте контакт в Leadteh для тестирования (пользователь должен написать боту команду /start)
2. Создайте Inner Webhook в настройках Leadteh
3. Скопируйте URL вебхука
4. Создайте сценарий, который будет срабатывать при получении вебхука

### Шаг 3: Настройка переменных в Leadteh

После получения вебхука, убедитесь, что в сценарии Leadteh вы используете правильные переменные:

- `{{customer_name}}` - имя и фамилия пользователя
- `{{customer_phone}}` - номер телефона пользователя
- `{{telegram_user_name}}` - имя пользователя из Telegram
- `{{telegram_id}}` - ID пользователя в Telegram
- `{{first_name}}` - имя пользователя
- `{{last_name}}` - фамилия пользователя

### Шаг 4: Тестирование интеграции

1. Откройте Web App через вашего Telegram бота
2. Заполните форму регистрации
3. Проверьте, что данные дошли до Leadteh
4. Убедитесь, что контакт найден по telegram_id
5. Проверьте, что переменные установлены корректно

## Тестирование интеграции

### Подготовка к тестированию

1. Убедитесь, что у вас есть доступ к аккаунту Leadteh
2. Убедитесь, что вебхук правильно настроен в системе Leadteh
3. Убедитесь, что контакт с соответствующим telegram_id существует в Leadteh (пользователь должен был написать боту команду /start)

### Тестирование интеграции

1. Откройте веб-приложение через Telegram бота
2. Заполните форму регистрации с корректными данными:
   - Имя (не менее 2 символов)
   - Фамилия (не менее 2 символов)
   - Номер телефона в формате +7 (XXX) XXX-XX-XX
   - Поставьте все необходимые галочки
3. Нажмите кнопку "Отправить"
4. После успешной отправки форма должна скрыться, и появиться сообщение об успехе
5. Проверьте в Leadteh, что данные были получены корректно

### Проверка результата в Leadteh

1. Войдите в ваш аккаунт Leadteh
2. Найдите контакт с соответствующим telegram_id
3. Проверьте, что переменные были установлены корректно:
   - customer_name
   - customer_phone
   - telegram_user_name
   - telegram_id
   - first_name
   - last_name
   - и другие переменные, указанные в интеграции

### Возможные ошибки и решения

1. Если данные не доходят до Leadteh:
   - Проверьте, что контакт с telegram_id существует в Leadteh
   - Проверьте, что вебхук правильно скопирован и настроен
   - Проверьте логи сервера на предмет ошибок

2. Если форма не отправляется:
   - Проверьте консоль браузера на предмет ошибок JavaScript
   - Убедитесь, что все поля формы заполнены корректно
   - Проверьте, что все обязательные галочки проставлены

## Деплой проекта

### Деплой на Vercel

1. Зарегистрируйтесь на [Vercel](https://vercel.com/)
2. Установите CLI инструмент (опционально):
   ```bash
   npm i -g vercel
   ```
3. Свяжите проект с Vercel:
   ```bash
   vercel
   ```
4. Следуйте инструкциям для деплоя
5. После деплоя вы получите URL для вашего приложения

### Настройка домена (опционально)

1. В настройках проекта на Vercel добавьте ваш домен
2. Следуйте инструкциям для настройки DNS записей

### Автоматический деплой

После подключения репозитория к Vercel, каждый пуш в ветку main будет автоматически деплоиться.

## Переменные окружения (Vercel)

| Переменная | Обязательная | Описание |
|------------|-------------|----------|
| `LEADTEH_API_TOKEN` | Нет | Токен API Leadteh для предзаполнения формы (`api/contact.js`) |
| `TELEGRAM_BOT_TOKEN` | Нет | Токен Telegram-бота для HMAC-SHA256 верификации initData (`api/submit.js`). Если не задан — верификация отключена, форма работает без проверки подписи |

Переменные задаются через `setup.js` (шаги 5 и 6) или вручную: Vercel Dashboard → Project → Settings → Environment Variables.

## Безопасность

### Верификация initData
Если задана env-переменная `TELEGRAM_BOT_TOKEN`, сервер проверяет HMAC-SHA256 подпись `initData` из Telegram Web App. Запросы с невалидной подписью отклоняются с кодом 403. Это предотвращает подделку запросов от имени других пользователей.

Если переменная не задана — верификация пропускается для обратной совместимости.

### Валидация telegram_id
Сервер проверяет что `telegram_id` — положительное целое число. Строки, отрицательные числа и прочие невалидные значения отклоняются с кодом 400.

## Заключение

Проект готов к использованию и легко адаптируется для разных аккаунтов Leadteh. Самый простой способ — запустить `node setup.js`, который проведёт через все шаги настройки. При ручной настройке главное изменить вебхук в файле `api/submit.js` и настроить соответствующий сценарий в Leadteh.