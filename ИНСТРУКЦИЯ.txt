=====================================
  Telegram Mini App - Регистрация
  Инструкция по установке
=====================================

ЧТО ВАМ ПОНАДОБИТСЯ
--------------------
- Компьютер с Windows 10/11, macOS или Linux
- Аккаунт в Leadteh (leadteh.ru)
- Аккаунт на GitHub (github.com) — бесплатный, нужен для Vercel
- Telegram-бот (создаётся через @BotFather)
- Ссылки на ваши документы (оферта, политика и т.д.) — если нужны


=====================
  УСТАНОВКА (Windows)
=====================
1. Скачайте файл install.bat
2. Запустите его двойным кликом
3. Если потребуется — скрипт установит Git и Node.js автоматически
   (после установки может потребоваться перезапуск скрипта)
4. Скрипт скачает проект и запустит мастер настройки


===========================
  УСТАНОВКА (macOS / Linux)
===========================

Как открыть Терминал:
  macOS: Finder → Программы → Утилиты → Терминал
         Или нажмите Cmd+Пробел, введите «Terminal», нажмите Enter

Вариант 1 — одной командой в терминале:
  curl -fsSL https://raw.githubusercontent.com/Roman72-186/telegram-webapp/main/install.sh | bash

Вариант 2 — скачать и запустить:
  1. Скачайте файл install.sh
  2. Откройте терминал в папке со скачанным файлом
  3. Выполните:
     chmod +x install.sh && ./install.sh

ЧТО ПРОИЗОЙДЁТ ПРИ ЗАПУСКЕ:

  Шаг 1 — Проверка Git
    На macOS для Git нужны Command Line Tools (Xcode CLT).
    Если они не установлены — откроется окно установки.
    Дождитесь завершения (может занять 5-10 минут),
    затем ПЕРЕЗАПУСТИТЕ скрипт той же командой.

  Шаг 2 — Проверка Node.js
    Если Node.js не найден — скрипт попробует установить.
    На macOS для установки может потребоваться Homebrew (brew).
    Если автоустановка не удалась — скачайте вручную: https://nodejs.org/

  Шаг 3 — Скачивание проекта
    Проект скачивается в папку ~/telegram-webapp.
    Если папка уже существует — скрипт обновит её (git pull),
    удалять не нужно.

  Шаг 4 — Мастер настройки
    Запускается setup.js, который задаёт вопросы (см. ниже).


НЮАНСЫ macOS:

  * Пароль при sudo
    Некоторые команды (установка Vercel CLI) требуют ввода пароля.
    Это пароль от вашей учётной записи macOS (которым входите в систему).
    При вводе пароля символы НЕ ОТОБРАЖАЮТСЯ — это нормально.
    Просто наберите пароль и нажмите Enter.

  * Если деплой не был выполнен во время установки
    После завершения скрипта вы окажетесь в домашней папке (~).
    Для ручного деплоя выполните по порядку:
      cd ~/telegram-webapp
      sudo npm i -g vercel       (введите пароль macOS, Enter)
      vercel --prod               (следуйте инструкциям Vercel)

  * Повторный запуск скрипта
    Можно запускать сколько угодно раз — скрипт обновит проект
    через git pull и заново запустит мастер настройки.


ЧТО СПРОСИТ МАСТЕР НАСТРОЙКИ
-----------------------------
Мастер настройки (setup.js) задаст несколько вопросов.
Для пропуска любого шага — просто нажмите Enter.

1. Webhook URL из Leadteh
   Где найти: Leadteh → Настройки → Интеграции → Inner Webhook
   Формат: https://xxx.leadteh.ru/inner_webhook/xxx-xxx-xxx

2. Ссылки на документы (3 штуки):
   - URL оферты
   - URL политики конфиденциальности
   - URL согласия на обработку данных

   ВАЖНО: Если какой-то документ вам не нужен — просто нажмите Enter,
   чтобы пропустить. Соответствующий чекбокс не будет показан
   пользователю в форме.

   Например, если вам нужно только согласие на обработку данных —
   пропустите оферту и политику, укажите только третий URL.

3. API-токен Leadteh (для предзаполнения формы)
   Если у пользователя уже есть контакт в Leadteh, форма заполнится
   автоматически (имя, фамилия, телефон).
   Где найти токен: Leadteh → Настройки → API → Скопировать токен.
   Можно пропустить (Enter) — форма будет пустой.

   Если вы пропустили этот шаг, можно добавить токен позже вручную:
   Vercel Dashboard → Project → Settings → Environment Variables
   Имя: LEADTEH_API_TOKEN
   Значение: ваш токен из Leadteh

4. Токен Telegram-бота (для безопасности)
   Повышает безопасность — сервер будет проверять подпись запросов
   из Telegram (HMAC-SHA256 верификация initData).
   Где найти: Telegram → @BotFather → /mybots → выберите бота → API Token.
   Можно пропустить (Enter) — форма будет работать без верификации.

   Если вы пропустили этот шаг, можно добавить токен позже вручную:
   Vercel Dashboard → Project → Settings → Environment Variables
   Имя: TELEGRAM_BOT_TOKEN
   Значение: токен вашего бота из BotFather

5. Установка Vercel CLI
   Если Vercel CLI не установлен — скрипт предложит установить.
   Нужен для деплоя (размещения) приложения в интернете.
   На macOS/Linux попросит пароль (sudo) — это нормально,
   введите пароль от вашей учётной записи и нажмите Enter.

6. Деплой на Vercel
   Скрипт предложит сразу задеплоить проект.
   Если у вас нет аккаунта Vercel — откроется страница регистрации.
   Vercel бесплатный, можно войти через GitHub-аккаунт.
   Если у вас нет GitHub — сначала зарегистрируйтесь на github.com
   (бесплатно), затем через него войдите в Vercel.


ПОСЛЕ ДЕПЛОЯ
-------------
1. Скопируйте URL, который выдаст Vercel после деплоя
   (выглядит как https://ваш-проект.vercel.app)

2. Укажите этот URL в кнопке Web App одним из способов:

   Способ 1 — через @BotFather (самый простой):
     Telegram → @BotFather → /mybots → выберите бота →
     Bot Settings → Menu Button → вставьте URL

   Способ 2 — через конструктор бота (Leadteh, и др.):
     Если ваш конструктор поддерживает тип кнопки «Web App» —
     создайте кнопку с этим типом и вставьте URL.
     Это работает так же, как через BotFather.

   Способ 3 — из кода бота (для разработчиков):
     Отправьте кнопку с параметром web_app и вашим URL.
     Пример (python-telegram-bot):
       InlineKeyboardButton("Регистрация", web_app=WebAppInfo(url="ВАШ_URL"))

3. Готово! Теперь у бота появится кнопка с Web App.


КАК ЭТО РАБОТАЕТ
-----------------
1. Пользователь пишет /start вашему боту (создаётся контакт в Leadteh)
2. Нажимает кнопку Web App
3. Если API-токен настроен — форма автоматически заполнится данными
   из Leadteh (имя, фамилия, телефон). Пользователь может изменить их.
4. Заполняет/проверяет форму (имя, фамилия, телефон)
5. Отмечает необходимые чекбоксы согласий
6. Данные отправляются в Leadteh CRM


ЧАСТЫЕ ПРОБЛЕМЫ
----------------
* «command not found: vercel» при попытке деплоя
  → Vercel CLI не установлен. Выполните:
    Windows:  npm i -g vercel
    macOS:    sudo npm i -g vercel
    Linux:    sudo npm i -g vercel

* «EACCES: permission denied» при npm i -g
  → На macOS/Linux нужен sudo. Выполните:
    sudo npm i -g vercel
    Введите пароль от учётной записи (символы не отображаются).

* «xcode-select: No developer tools were found» на macOS
  → Дождитесь завершения установки в открывшемся окне,
    затем перезапустите скрипт установки.

* Папка telegram-webapp уже существует
  → Это нормально. Скрипт обновит её через git pull.
    Удалять не нужно.

* Форма не открывается в Telegram
  → Проверьте что URL правильно указан в настройках бота.
  → URL должен начинаться с https://

* Данные не приходят в Leadteh
  → Убедитесь что пользователь написал /start боту.
  → Проверьте Webhook URL в api/submit.js.


УСТАНОВКА ДЛЯ ДРУГОГО БОТА
----------------------------
Если вы хотите подключить ещё одного бота (другой аккаунт Leadteh),
нужна отдельная копия проекта и отдельный деплой на Vercel.

Каждый бот = отдельная папка + отдельный проект Vercel + свой URL.

  Windows:
    1. Откройте командную строку
    2. git clone https://github.com/Roman72-186/telegram-webapp.git telegram-webapp-bot2
    3. cd telegram-webapp-bot2
    4. node setup.js
    5. Укажите данные нового бота (webhook, токены и т.д.)

  macOS / Linux:
    1. Откройте терминал
    2. git clone https://github.com/Roman72-186/telegram-webapp.git telegram-webapp-bot2
    3. cd telegram-webapp-bot2
    4. node setup.js < /dev/tty
    5. Укажите данные нового бота (webhook, токены и т.д.)

  Для каждого бота указываются СВОИ:
    - Webhook URL (от своего аккаунта Leadteh)
    - API-токен Leadteh
    - Токен Telegram-бота
    - Ссылки на документы (могут совпадать)

  При деплое Vercel создаст новый проект с новым URL.
  Этот URL указываете в настройках нового бота.


ОБНОВЛЕНИЕ
-----------
Если вышла новая версия:

  Windows:
    Откройте командную строку в папке проекта:
    git pull origin main
    vercel --prod

  macOS / Linux:
    cd ~/telegram-webapp
    git pull origin main
    vercel --prod

  Или просто перезапустите install.sh — он сам обновит проект.

  Если у вас несколько ботов — обновите каждую папку отдельно:
    cd ~/telegram-webapp-bot2
    git pull origin main
    vercel --prod
